# 시간 기록 시스템 검증 가이드

## 🎯 개요

Habitus33 메모카드 시간 기록 시스템이 사용자 현지 시간을 정확히 기록하도록 개선되었습니다. 이 가이드는 배포 전후 시스템 검증 방법을 제공합니다.

## 🚀 배포 전 검증 단계

### 1단계: 서버 시간대 설정 확인

```bash
# 서버 시간대 정보 확인
npm run check-timezone

# 시간대 설정 문제 진단
npm run validate-timezone
```

**기대 결과:**
- TZ=Asia/Seoul 환경변수 설정됨
- 서버가 한국 시간대(UTC+9) 사용
- 모든 검증 항목 통과

### 2단계: MongoDB Atlas 스키마 검증

```bash
# Atlas 환경 검증
npm run validate-atlas

# 인덱스 생성 모니터링
npm run monitor-atlas
```

**기대 결과:**
- MongoDB 연결 정상
- Note.clientCreatedAt 필드 존재 확인
- 인덱스 정상 생성

### 3단계: 통합 테스트 실행

```bash
# 전체 통합 테스트
npm run integration-test

# 시간 시스템 전용 테스트
npm run test-time-system
```

**기대 결과:**
- 6개 시간대 시나리오 모두 통과
- 기존 기능 정상 동작 확인
- 데이터베이스 성능 기준 만족

## 🌐 배포 후 검증 단계

### 1단계: API 헬스체크 확인

```bash
# 프로덕션 헬스체크 (브라우저 또는 curl)
https://habitus33-api.onrender.com/api/health
```

**확인 사항:**
```json
{
  "status": "ok",
  "timezone": {
    "envTimezone": "Asia/Seoul",
    "isKoreanTime": true,
    "currentTime": "2024-01-XX...",
    "koreaTime": "2024. 1. XX..."
  }
}
```

### 2단계: 실제 메모 생성 테스트

1. **프론트엔드에서 TS 세션 진행**
2. **메모 작성 및 완료**
3. **TSNoteCard에서 시간 표시 확인**

**확인 사항:**
- 메모 생성 시간이 사용자 현지 시간과 일치
- 서로 다른 시간대 사용자들의 메모 시간 정확성

### 3단계: 데이터베이스 직접 확인 (옵션)

MongoDB Atlas Console에서:
```javascript
// 최근 생성된 Note 확인
db.notes.find().sort({createdAt: -1}).limit(5)

// clientCreatedAt 필드 존재 확인
db.notes.findOne({clientCreatedAt: {$exists: true}})
```

## 🧪 시간대별 테스트 시나리오

### 정상 케이스
1. **한국 (서울)**: Asia/Seoul, UTC+9
2. **미국 동부 (뉴욕)**: America/New_York, UTC-5/-4
3. **영국 (런던)**: Europe/London, UTC+0/+1
4. **일본 (도쿄)**: Asia/Tokyo, UTC+9

### 예외 케이스
5. **비정상 미래 시간**: 25시간 후 → 서버 시간 사용
6. **비정상 과거 시간**: 25시간 전 → 서버 시간 사용

## 🚨 문제 해결 가이드

### 시간대 설정 문제

**증상**: `isKoreanTime: false`
**해결**:
```bash
# render.yaml 확인
cat backend/render.yaml | grep TZ

# 배포 후 재확인
npm run check-timezone
```

### 클라이언트 시간 미사용

**증상**: 모든 메모가 서버 시간으로 기록
**확인**:
1. 브라우저 개발자 도구에서 네트워크 탭 확인
2. TS 세션 완료 API 요청에 시간 정보 포함 여부
3. `timeUtils.ts`의 `collectClientTimeInfo()` 정상 동작

### 성능 문제

**증상**: 메모 생성/조회 속도 저하
**확인**:
```bash
# 성능 테스트 실행
npm run test-time-system

# MongoDB 인덱스 상태 확인
npm run monitor-atlas
```

## 📊 성공 기준

### 기능적 요구사항
- ✅ 사용자 현지 시간으로 메모 기록
- ✅ 기존 데이터 100% 호환성 유지
- ✅ 시간대 변경 시 정확한 시간 표시

### 성능 요구사항
- ✅ 메모 생성 속도: 기존 대비 5% 이내 차이
- ✅ 메모 조회 속도: 인덱스 활용으로 개선
- ✅ 데이터베이스 쿼리: 100ms 이하

### 안정성 요구사항
- ✅ 비정상 클라이언트 시간 자동 차단
- ✅ 네트워크 오류 시 서버 시간 fallback
- ✅ 모든 기존 기능 정상 동작

## 🔧 유지보수 명령어

```bash
# 정기 점검 (월 1회 권장)
npm run validate-timezone
npm run validate-atlas
npm run test-time-system

# 문제 발생 시 진단
npm run check-timezone
npm run monitor-atlas

# 성능 모니터링
npm run integration-test
```

## 📝 배포 체크리스트

### 배포 전
- [ ] `npm run check-timezone` 통과
- [ ] `npm run validate-atlas` 통과  
- [ ] `npm run integration-test` 통과
- [ ] 모든 TypeScript 컴파일 오류 해결

### 배포 후
- [ ] API 헬스체크에서 `isKoreanTime: true` 확인
- [ ] 실제 메모 생성 테스트 성공
- [ ] 서로 다른 시간대에서 접근 테스트
- [ ] 기존 사용자 데이터 정상 표시 확인

---

**⚠️ 주의사항:**
- 모든 테스트는 실제 프로덕션 데이터에 영향을 주지 않습니다
- 테스트 실패 시 배포를 중단하고 문제를 해결한 후 재시도하세요
- 시간 관련 변경사항은 사용자 경험에 직접적인 영향을 미치므로 신중하게 검증하세요 