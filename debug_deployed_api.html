<!DOCTYPE html>
<html>
<head>
    <title>HABITUS33 V2 API ë””ë²„ê·¸</title>
    <style>
        body { font-family: monospace; margin: 20px; background: #1a1a1a; color: #00ffff; }
        .container { max-width: 800px; margin: 0 auto; }
        .result { background: #2d2d2d; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffcccc; color: #800000; }
        .success { background: #ccffcc; color: #008000; }
        button { background: #007acc; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        input { padding: 8px; margin: 5px; width: 300px; }
        pre { background: #333; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§  HABITUS33 V2 ì¸ì§€ì¸¡ì • API ë””ë²„ê·¸</h1>
        
        <div>
            <h3>1. ì¸ì¦ í† í° ì…ë ¥</h3>
            <input id="tokenInput" placeholder="Bearer í† í°ì„ ì…ë ¥í•˜ì„¸ìš”" type="password">
            <button onclick="testAuth()">í† í° í…ŒìŠ¤íŠ¸</button>
        </div>

        <div>
            <h3>2. V2 ì¸ì§€ì¸¡ì • API í…ŒìŠ¤íŠ¸</h3>
            <select id="timeRange">
                <option value="1m">1ê°œì›”</option>
                <option value="3m" selected>3ê°œì›”</option>
                <option value="6m">6ê°œì›”</option>
                <option value="all">ì „ì²´</option>
            </select>
            <button onclick="testCognitiveAPI()">V2 API í…ŒìŠ¤íŠ¸</button>
            <button onclick="getTokenFromStorage()">ì €ì¥ëœ í† í° ì‚¬ìš©</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const API_BASE = 'https://habitus33-api.onrender.com';
        
        function addResult(content, className = '') {
            const div = document.createElement('div');
            div.className = `result ${className}`;
            div.innerHTML = content;
            document.getElementById('results').appendChild(div);
        }

        function getTokenFromStorage() {
            // localStorageë‚˜ sessionStorageì—ì„œ í† í° ì°¾ê¸°
            const token = localStorage.getItem('token') || 
                         sessionStorage.getItem('token') ||
                         localStorage.getItem('authToken') ||
                         sessionStorage.getItem('authToken');
            
            if (token) {
                document.getElementById('tokenInput').value = token;
                addResult(`âœ… ì €ì¥ëœ í† í° ë°œê²¬: ${token.substring(0, 20)}...`, 'success');
            } else {
                addResult('âŒ ì €ì¥ëœ í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
            }
        }

        async function testAuth() {
            const token = document.getElementById('tokenInput').value;
            if (!token) {
                addResult('âŒ í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/health`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                addResult(`âœ… í—¬ìŠ¤ì²´í¬ ì‘ë‹µ (${response.status}):<pre>${JSON.stringify(data, null, 2)}</pre>`, 'success');
            } catch (error) {
                addResult(`âŒ í—¬ìŠ¤ì²´í¬ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        async function testCognitiveAPI() {
            const token = document.getElementById('tokenInput').value;
            const timeRange = document.getElementById('timeRange').value;
            
            if (!token) {
                addResult('âŒ í† í°ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            addResult(`ğŸ” V2 ì¸ì§€ì¸¡ì • API í…ŒìŠ¤íŠ¸ ì‹œì‘ (ì‹œê°„ë²”ìœ„: ${timeRange})`);

            try {
                const response = await fetch(`${API_BASE}/api/cognitive/metrics?timeRange=${timeRange}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const responseText = await response.text();
                let data;
                
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    addResult(`âŒ JSON íŒŒì‹± ì˜¤ë¥˜. ì‘ë‹µ: ${responseText}`, 'error');
                    return;
                }

                if (!response.ok) {
                    addResult(`âŒ API ì˜¤ë¥˜ (${response.status}): ${data.message || data.error}`, 'error');
                    return;
                }

                // í•µì‹¬ ë””ë²„ê·¸ ì •ë³´ ì¶”ì¶œ
                const debugInfo = {
                    fetchedSessionCount: data.debug_fetchedSessionCount,
                    overallProfileSample: Object.keys(data.overallProfile || {}).reduce((acc, key) => {
                        acc[key] = Math.round(data.overallProfile[key] || 0);
                        return acc;
                    }, {}),
                    historicalDataCount: data.historicalData?.length || 0,
                    hasV2Metrics: !!(data.overallProfile?.spatialMemoryAccuracy),
                    strengths: data.strengths,
                    improvementAreas: data.improvementAreas
                };

                addResult(`ğŸ“Š V2 API ì‘ë‹µ ì„±ê³µ!<pre>${JSON.stringify(debugInfo, null, 2)}</pre>`, 'success');

                // ë¬¸ì œ ì§„ë‹¨
                if (debugInfo.fetchedSessionCount === 0) {
                    addResult(`ğŸš¨ ë¬¸ì œ ë°œê²¬: ì  ê³  ì„¸ì…˜ ë°ì´í„°ê°€ 0ê°œ ì¡°íšŒë¨. ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ë˜ëŠ” ì‚¬ìš©ì ID ë¬¸ì œ ê°€ëŠ¥ì„±`, 'error');
                } else if (debugInfo.fetchedSessionCount > 0) {
                    const avgScore = Object.values(debugInfo.overallProfileSample).reduce((a, b) => a + b, 0) / Object.keys(debugInfo.overallProfileSample).length;
                    if (Math.abs(avgScore - 50) < 5) {
                        addResult(`ğŸš¨ ë¬¸ì œ ë°œê²¬: ${debugInfo.fetchedSessionCount}ê°œ ì„¸ì…˜ì´ ìˆì§€ë§Œ í‰ê· ì ìˆ˜ê°€ ${avgScore.toFixed(1)}ì  (ê¸°ë³¸ê°’ 50ì— ê°€ê¹Œì›€). V2 ê³„ì‚° ë¡œì§ ë¬¸ì œ ê°€ëŠ¥ì„±`, 'error');
                    } else {
                        addResult(`âœ… ì •ìƒ: ${debugInfo.fetchedSessionCount}ê°œ ì„¸ì…˜ìœ¼ë¡œ í‰ê· ì ìˆ˜ ${avgScore.toFixed(1)}ì  ê³„ì‚°ë¨`, 'success');
                    }
                }

                // ì „ì²´ ì‘ë‹µ ë°ì´í„° í‘œì‹œ (ì ‘ì„ ìˆ˜ ìˆê²Œ)
                addResult(`
                    <details>
                        <summary>ì „ì²´ ì‘ë‹µ ë°ì´í„° ë³´ê¸°</summary>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </details>
                `);

            } catch (error) {
                addResult(`âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ì €ì¥ëœ í† í° ì°¾ê¸°
        window.onload = function() {
            getTokenFromStorage();
        };
    </script>
</body>
</html>