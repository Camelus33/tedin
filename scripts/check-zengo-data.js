/**
 * MongoDB 데이터베이스의 zengo 컬렉션 데이터 확인 스크립트
 * 
 * 이 스크립트는 다음 사항을 확인합니다:
 * 1. 테스트용 자동 생성 속담이 없는지
 * 2. totalWords와 wordMappings 길이가 일치하는지
 * 3. totalAllowedStones가 totalWords 이상인지
 * 
 * 실행 방법: node scripts/check-zengo-data.js
 */

const { MongoClient } = require('mongodb');

// MongoDB 연결 정보
const MONGODB_URI = process.env.MONGODB_URI || 'mongodb://localhost:27017/habitus33';

async function checkZengoData() {
  let client;
  
  try {
    // MongoDB에 연결
    client = new MongoClient(MONGODB_URI);
    await client.connect();
    console.log('MongoDB에 연결되었습니다.');
    
    const db = client.db();
    const zengoCollection = db.collection('zengo');
    
    // 전체 데이터 개수 확인
    const totalCount = await zengoCollection.countDocuments({});
    console.log(`총 속담 데이터 수: ${totalCount}개`);
    
    // 1. 테스트 데이터 확인
    const autoGeneratedCount = await zengoCollection.countDocuments({
      proverbText: /^Auto generated proverb/
    });
    console.log(`테스트용 속담 데이터 수: ${autoGeneratedCount}개`);
    
    // 2 & 3. 불일치 데이터 확인
    const allProverbs = await zengoCollection.find({}).toArray();
    let wordMappingsMismatch = 0;
    let allowedStonesMismatch = 0;
    
    console.log('\n=== 속담 데이터 확인 결과 ===');
    
    for (const proverb of allProverbs) {
      const wordMappingsLength = proverb.wordMappings ? proverb.wordMappings.length : 0;
      let hasIssue = false;
      
      // totalWords와 wordMappings 길이 확인
      if (proverb.totalWords !== wordMappingsLength) {
        wordMappingsMismatch++;
        hasIssue = true;
        console.log(`[❌] "${proverb.proverbText}" (${proverb.level}, ${proverb.language})`);
        console.log(`  - totalWords(${proverb.totalWords})와 wordMappings 길이(${wordMappingsLength})가 불일치`);
      }
      
      // totalAllowedStones 확인
      if (proverb.totalAllowedStones < proverb.totalWords) {
        allowedStonesMismatch++;
        if (!hasIssue) {
          console.log(`[❌] "${proverb.proverbText}" (${proverb.level}, ${proverb.language})`);
        }
        console.log(`  - totalAllowedStones(${proverb.totalAllowedStones})가 totalWords(${proverb.totalWords})보다 작음`);
      }
    }
    
    console.log('\n=== 요약 ===');
    console.log(`총 속담 수: ${totalCount}개`);
    console.log(`테스트용 속담: ${autoGeneratedCount}개 (${autoGeneratedCount === 0 ? '✅ 없음' : '❌ 존재'})`);
    console.log(`totalWords 불일치: ${wordMappingsMismatch}개 (${wordMappingsMismatch === 0 ? '✅ 없음' : '❌ 존재'})`);
    console.log(`totalAllowedStones 불일치: ${allowedStonesMismatch}개 (${allowedStonesMismatch === 0 ? '✅ 없음' : '❌ 존재'})`);
    
    if (autoGeneratedCount === 0 && wordMappingsMismatch === 0 && allowedStonesMismatch === 0) {
      console.log('\n✅ 모든 데이터가 정상입니다!');
    } else {
      console.log('\n❌ 아직 해결해야 할 문제가 있습니다. update-zengo-data.js 스크립트를 실행하여 데이터를 수정하세요.');
    }
    
  } catch (error) {
    console.error('데이터 확인 중 오류 발생:', error);
  } finally {
    // 연결 종료
    if (client) {
      await client.close();
      console.log('\nMongoDB 연결이 종료되었습니다.');
    }
  }
}

// 스크립트 실행
checkZengoData().catch(console.error); 